{{! views/register_form.hbs }}

<style>
  /* Container */
  .reg-container {
    max-width: 980px;
    margin: 24px auto;
    padding: 26px;
    background: #ffffff;
    border-radius: 12px;
    box-shadow: 0 6px 18px rgba(17,24,39,0.06);
    font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    color: #0f172a;
  }

  h1.reg-title {
    margin: 0 0 18px;
    font-size: 40px;
    line-height: 1.05;
    letter-spacing: -0.5px;
  }

  fieldset.section {
    border: 1px solid #d7dfe8;
    padding: 16px;
    margin-bottom: 18px;
    border-radius: 8px;
    background: #fbfdff;
  }

  fieldset.section legend {
    font-weight: 700;
    padding: 0 8px;
    color: #0b2545;
  }

  /* Two-column grid for inputs */
  .form-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 14px 26px;
    align-items: start;
  }

  /* Single full-width rows */
  .full-row {
    grid-column: 1 / -1;
  }

  label.form-label {
    display: flex;
    flex-direction: column;
    gap: 8px;
    font-weight: 600;
    font-size: 15px;
    color: #0b2545;
  }

  input[type="text"],
  input[type="email"],
  input[type="tel"],
  input[type="date"],
  select,
  textarea {
    height: 40px;
    padding: 8px 12px;
    border-radius: 8px;
    border: 1px solid #cfd8e3;
    background: #fff;
    font-size: 14px;
    outline: none;
    transition: box-shadow .12s ease, border-color .12s ease;
    box-sizing: border-box;
  }

  textarea {
    min-height: 90px;
    padding: 10px 12px;
    resize: vertical;
  }

  input:focus, select:focus, textarea:focus {
    border-color: #7aa7ff;
    box-shadow: 0 6px 18px rgba(10, 94, 255, 0.08);
  }

  .form-actions {
    display:flex;
    gap:12px;
    align-items:center;
    margin-top:8px;
  }

  button.btn-primary {
    background: linear-gradient(180deg,#0b66d0,#0358b6);
    color: #fff;
    border: 0;
    padding: 12px 18px;
    border-radius: 10px;
    cursor: pointer;
    font-weight:700;
  }

  a.btn-cancel {
    display:inline-block;
    padding: 10px 14px;
    color: #0b2545;
    text-decoration: none;
    border-radius: 8px;
    border: 1px solid transparent;
  }

  .muted {
    color:#556174;
    font-size:13px;
  }

  .indemnity-box { border-radius:8px; background:#fff; }

  /* Responsive */
  @media (max-width: 880px) {
    .form-grid { grid-template-columns: 1fr; }
    .reg-container { padding:18px; margin:12px; }
    h1.reg-title { font-size:32px; }
  }
</style>

<div class="reg-container">
  <h1 class="reg-title">{{title}}</h1>

  {{#if errors}}
    <div style="background:#fff4f4;border:1px solid #ffd6d6;padding:12px;border-radius:8px;margin-bottom:12px">
      <strong style="color:#9b1c1c">Please fix the following:</strong>
      <ul style="margin:8px 0 0 18px;color:#7b2a2a">
        {{#each errors}}
          <li>{{msg}}</li>
        {{/each}}
      </ul>
    </div>
  {{/if}}

  <form id="registrationForm" method="post" action="/register" autocomplete="on" novalidate>
    <input type="hidden" name="schoolSlug" value="{{school.slug}}">
    <input type="hidden" name="schoolName" value="{{school.name}}">

    <fieldset class="section">
      <legend>Student details</legend>

      <div class="form-grid">
        <label class="form-label">
          First name
          <input id="studentFirstName" name="studentFirstName" value="{{form.studentFirstName}}" required placeholder="e.g. John">
        </label>

        <label class="form-label">
          Middle name
          <input id="studentMiddleName" name="studentMiddleName" value="{{form.studentMiddleName}}" placeholder="optional">
        </label>

        <label class="form-label">
          Last name
          <input id="studentLastName" name="studentLastName" value="{{form.studentLastName}}" required placeholder="e.g. Doe">
        </label>

        <label class="form-label">
          Date of birth
          <input type="date" id="dateOfBirth" name="dateOfBirth" value="{{form.dateOfBirth}}">
        </label>

        <label class="form-label full-row">
          Gender
          <select name="gender" aria-label="Gender">
            <option value="">Select</option>
            <option value="Boy" {{#ifEquals form.gender "Boy"}}selected{{/ifEquals}}>Boy</option>
            <option value="Girl" {{#ifEquals form.gender "Girl"}}selected{{/ifEquals}}>Girl</option>
            <option value="Other" {{#ifEquals form.gender "Other"}}selected{{/ifEquals}}>Other</option>
          </select>
        </label>

        <label class="form-label">
          Current Grade / Stage
          <input name="currentGrade" value="{{form.currentGrade}}" placeholder="e.g. Grade 3 / Year 1">
        </label>

        <label class="form-label">
          Languages spoken
          <input name="languagesSpoken" value="{{form.languagesSpoken}}" placeholder="e.g. English, Shona">
        </label>

        <label class="form-label full-row">
          Allergies / Medical info
          <input name="allergies" value="{{form.allergies}}" placeholder="Allergies, medical notes (optional)">
        </label>
      </div>
    </fieldset>

    <fieldset class="section">
      <legend>Parent / Guardian</legend>

      <div class="form-grid">
        <label class="form-label">
          Father's name
          <input id="fatherName" name="fatherName" value="{{form.fatherName}}" placeholder="Full name">
        </label>

        <label class="form-label">
          Father's mobile
          <input id="fatherMobile" name="fatherMobile" value="{{form.fatherMobile}}" placeholder="+263 77 123 4567" type="tel">
        </label>

        <label class="form-label">
          Father's email
          <input id="fatherEmail" name="fatherEmail" value="{{form.fatherEmail}}" placeholder="email@example.com" type="email">
        </label>

        <label class="form-label">
          Mother's name
          <input id="motherName" name="motherName" value="{{form.motherName}}" placeholder="Full name">
        </label>

        <label class="form-label">
          Mother's mobile
          <input id="motherMobile" name="motherMobile" value="{{form.motherMobile}}" placeholder="+263 77 123 4567" type="tel">
        </label>

        <label class="form-label">
          Mother's email
          <input id="motherEmail" name="motherEmail" value="{{form.motherEmail}}" placeholder="email@example.com" type="email">
        </label>

        <label class="form-label full-row">
          Home address
          <input name="homeAddress" value="{{form.homeAddress}}" placeholder="Street, Suburb, City">
        </label>

        <label class="form-label full-row">
          Work address
          <input name="workAddress" value="{{form.workAddress}}" placeholder="Company / office address (optional)">
        </label>
      </div>
    </fieldset>

    <fieldset class="section indemnity-box">
      <legend>Indemnity & Consent</legend>

      <!-- brief original paragraph (kept for users who don't expand) -->
      <p class="muted">Please read the school's indemnity and consent (expand below to view full terms).</p>

      <!-- COLLAPSIBLE INDEMNITY (auto-fill placeholders inside) -->
      <div style="margin-top:8px">
        <details id="indemnityDetails" style="border-top:1px solid #eef4fb;padding-top:12px" aria-expanded="false">
          <summary style="cursor:pointer;font-weight:700;color:#0b2545;padding:6px 4px">
            Read the indemnity & consent terms (click to expand)
          </summary>

          <div style="margin-top:12px;line-height:1.5;color:#2d3b49;font-size:0.98rem">
            <p style="white-space:pre-line;margin:0 0 10px 0">
I/We, <span id="parentNameSpan">______________________________________</span> [Parent/Guardian Name], being the 
parent/guardian of <span id="studentNameSpan">_______________________________________</span> [Student Name], hereby 
acknowledge and agree to the following terms and conditions:
1. School Bus and Meal Arrangements: I/We understand that a 30-day written notice is required to 
cancel school bus or meal services, failing which I/we will be liable for the charges.
2. Fee Payments: I/We agree to pay school fees in full via bank transfer or deposit. No discounts will 
be applied for sibling or once-off payments.
3. Payment Terms: I/We understand that fees must be paid on or before the opening of term or on 
the 1st of each month (if on a payment plan). Failure to meet this deadline may result in the 
school withholding services to my/our child until all outstanding balances are cleared.
4. Child's Health and Well-being: I/We acknowledge that it remains our responsibility to ensure our 
child's health and well-being while at school, including providing necessary medication and care.
5. Liability for Incidents: I/We hereby indemnify and hold harmless St Eurit International School, its 
employees, agents, and affiliates from any claims, demands, or liabilities arising from any 
incidents, accidents, or injuries to our child while participating in school activities, trips, sports, or 
functions.
6. Personal Belongings: I/We acknowledge that any valuable items brought to school or school 
events by our child remain our responsibility, and we will not hold the school liable for any loss 
or damage.
7. Media Consent: I/We consent to the school using photographs or videos of our child on the school 
website, social media platforms, or other promotional materials.
8. Discipline and Punishment: I/We consent to the school authorities disciplining our child in a 
manner deemed fit, provided it does not involve corporal punishment unless given consent in 
writing, abuse, or infliction of physical harm.
9. Bullying: In the event that my/our child is found to be involved in bullying other learners, I/we 
hereby consent to the school disciplining my/our child in any form deemed fit to reprimand and 
correct their behaviour, including but not limited to detention, suspension, or other disciplinary 
measures as per the school's policies.
10. Communication: I/We agree to keep the school informed of any changes to our contact details, 
medical conditions, or other relevant information.
11. Rules and Regulations: I/We acknowledge that our child will abide by the school's rules and 
regulations, as amended from time to time.
12. Dress Code: I/We understand that the school has the right to deny entry to my/our child if they are 
not properly dressed according to the school's standards. I/We agree to ensure that my/our child 
wears the school uniform in good condition and refrain from wearing torn or tattered uniforms 
that may compromise the school's brand and standards.
13. Compulsory Activities: I/We agree to ensure our child's participation in all compulsory school 
activities, including but not limited to: Speech and Prize Giving Day. Two fundraising activities 
per term, each with a contribution of $5.
14. Please note that fees are charged per term but can optionally be paid in monthly instalments. Fees 
paid before opening day may attract discounts if paid in cash meaning fees paid after opening day 
have no discounts neither sibling nor once-off.
15. When a student wants to transfer, please give a term's notice in writing before transferring; otherwise 
you will be blacklisted and charged for the term you didnâ€™t serve notice.
            </p>

            <p style="font-size:0.95rem;color:#445569;margin-top:8px">
              You can also view the scanned indemnity here:
              <a href="/mnt/data/indemnity consent.png" target="_blank" rel="noopener">/mnt/data/indemnity consent.png</a>
              &nbsp;|&nbsp;
              <a href="/mnt/data/fe43b77b-e53f-4514-9342-a7bbe54e9383.png" target="_blank" rel="noopener">/mnt/data/fe43b77b-e53f-4514-9342-a7bbe54e9383.png</a>
            </p>
          </div>
        </details>
      </div>

      <!-- checkbox and short note (keeps previous UX) -->
      <div style="margin-top:12px;display:flex;align-items:center;gap:10px;flex-wrap:wrap">
        <label style="display:flex;align-items:center;gap:10px;font-weight:600">
          <input id="indemnityAccepted" type="checkbox" name="indemnityAccepted" value="1" {{#if form.indemnityAccepted}}checked{{/if}}>
          <span style="font-weight:600">I accept the indemnity terms.</span>
        </label>

        <input type="hidden" name="indemnityText" id="indemnityTextInput" value="Parent accepted indemnity on form">

        <div style="margin-left:auto;font-size:13px;color:#556174">
          Questions? <a href="mailto:{{schoolContactEmail}}">{{schoolContactEmail}}</a>
        </div>
      </div>

      <!-- inline error placeholder (hidden unless validation fails) -->
      <div id="indemnityError" role="alert" style="display:none;margin-top:8px;color:#9b1c1c;font-weight:700"></div>
    </fieldset>

    <div class="form-actions">
      <button type="submit" class="btn-primary">Submit registration</button>
      <a class="btn-cancel" href="/">Cancel</a>
      <div style="margin-left:auto; font-size:13px; color:#556174">Questions? <a href="mailto:{{schoolContactEmail}}">{{schoolContactEmail}}</a></div>
    </div>
  </form>
</div>

<script>
  (function () {
    // Elements
    const form = document.getElementById('registrationForm');
    const errorBox = document.getElementById('indemnityError');
    const checkbox = document.getElementById('indemnityAccepted');

    // placeholder spans inside collapsible text
    const parentNameSpan = document.getElementById('parentNameSpan');
    const studentNameSpan = document.getElementById('studentNameSpan');

    // helper to fetch value by id or name
    function inputValue(...keys) {
      for (const k of keys) {
        if (!k) continue;
        const elById = document.getElementById(k);
        if (elById && elById.value !== undefined) {
          const v = String(elById.value || '').trim();
          if (v) return v;
        }
        const elByName = form.elements[k];
        if (elByName && elByName.value !== undefined) {
          const v = String(elByName.value || '').trim();
          if (v) return v;
        }
      }
      return '';
    }

    // build parent/guardian display name (prefer explicit parentName -> fatherName & motherName)
    function buildParentName() {
      const parent = inputValue('parentName','parent_name');
      if (parent) return parent;
      const father = inputValue('fatherName','father_name');
      const mother = inputValue('motherName','mother_name');
      if (father && mother) return father + ' & ' + mother;
      return father || mother || '';
    }

    // build student display name
    function buildStudentName() {
      const first = inputValue('studentFirstName','student_first_name','firstName','firstname');
      const middle = inputValue('studentMiddleName','student_middle_name','middleName','middlename') || '';
      const last = inputValue('studentLastName','student_last_name','lastName','lastname') || '';
      const parts = [first, middle, last].filter(Boolean);
      if (parts.length) return parts.join(' ');
      return inputValue('studentName','student_name') || '';
    }

    // refresh the blanks in the collapsible text
    function refreshPlaceholders() {
      const p = buildParentName();
      const s = buildStudentName();
      parentNameSpan.textContent = p || '______________________________________';
      studentNameSpan.textContent = s || '_______________________________________';
    }

    // initial fill
    refreshPlaceholders();

    // wire input listeners for live update (only on fields that exist)
    const watchKeys = [
      'parentName','parent_name','fatherName','father_name','motherName','mother_name',
      'studentFirstName','studentMiddleName','studentLastName',
      'student_first_name','student_middle_name','student_last_name','firstName','lastName','studentName','student_name'
    ];
    watchKeys.forEach(k => {
      const el = document.getElementById(k) || (form.elements ? form.elements[k] : null);
      if (el) {
        el.addEventListener('input', refreshPlaceholders);
        el.addEventListener('change', refreshPlaceholders);
      }
    });

    // validation: required fields (keeps your existing checks) + indemnity checkbox enforcement
    if (form) {
      form.addEventListener('submit', function (ev) {
        // reset error
        errorBox.style.display = 'none';
        errorBox.textContent = '';

        // basic required check (preserve existing behaviour)
        const required = ['studentFirstName', 'studentLastName', 'fatherMobile'];
        for (const name of required) {
          const el = form.elements[name];
          if (el && String(el.value || '').trim() === '') {
            ev.preventDefault();
            el.focus();
            el.style.boxShadow = '0 6px 18px rgba(255,50,50,0.08)';
            return false;
          }
        }

        // enforce indemnity checkbox
        if (checkbox && !checkbox.checked) {
          ev.preventDefault();
          errorBox.textContent = 'You must accept the indemnity terms before submitting the registration.';
          errorBox.style.display = 'block';
          // open details and focus checkbox for accessibility
          const details = document.getElementById('indemnityDetails');
          if (details && !details.open) details.open = true;
          checkbox.focus();
          document.getElementById('registrationForm').scrollIntoView({ behavior: 'smooth', block: 'center' });
          return false;
        }

        // set indemnityText with snapshot (optional)
        const snapshot = `Accepted by: ${buildParentName() || '[not provided]'}; Student: ${buildStudentName() || '[not provided]'}; Date: ${new Date().toISOString()}`;
        const indemnityTextInput = document.getElementById('indemnityTextInput');
        if (indemnityTextInput) indemnityTextInput.value = snapshot;

        // allow submit
        return true;
      }, { passive: false });
    }

    // clear error when checkbox toggled
    if (checkbox) {
      checkbox.addEventListener('change', function () {
        if (this.checked) {
          errorBox.style.display = 'none';
          errorBox.textContent = '';
        }
      });
    }
  })();
</script>
